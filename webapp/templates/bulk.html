{% extends 'base.html' %}
{% block content %}
<h3 class="mb-3"><i class="fa-solid fa-layer-group me-2"></i>{{ t('bulk_title') }}</h3>
<form id="form" class="mb-3">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <textarea id="json" class="form-control" rows="10" placeholder="{{ t('upload_json') }}"></textarea>
  <button class="btn btn-brand mt-2" id="start">{{ t('run_bulk') }}</button>
</form>
<div id="spinner" class="spinner-border text-primary ms-2 d-none" role="status"></div>
<pre id="log" class="mt-3" style="height:300px;overflow:auto;"></pre>
<div id="status" class="alert alert-success d-none mt-2"></div>
{% endblock %}
{% block scripts %}
<script>
  const form = document.getElementById('form');
  const startBtn = document.getElementById('start');
  const spinner = document.getElementById('spinner');
  const status = document.getElementById('status');
  form.onsubmit = function(e){
    e.preventDefault();
    const log = document.getElementById('log');
    log.textContent='';
    status.classList.add('d-none');
    spinner.classList.remove('d-none');
    startBtn.disabled = true;
    fetch('/bulk-upload', {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'X-CSRFToken': form.csrf_token.value},
      body: document.getElementById('json').value
    }).then(resp => {
      if(!resp.ok){ spinner.classList.add('d-none'); startBtn.disabled=false; return; }
      const es = new EventSource('/stream/bulk');
      es.onmessage = e => {
        if(e.data === '--done--'){
          es.close();
          spinner.classList.add('d-none');
          startBtn.disabled = false;
          status.textContent = "{{ t('update_completed') }}";
          status.classList.remove('d-none');
        }else{
          log.textContent += e.data + '\n';
        }
        log.scrollTop = log.scrollHeight;
      };
    });
  };
</script>
{% endblock %}
